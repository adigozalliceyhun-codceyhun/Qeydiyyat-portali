<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Qeydiyyat Portalƒ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: contain;
    }

    .bg-gradient-mobile {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      background-color: #0f172a;
      background-image:
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%),
        radial-gradient(at 0% 100%, hsla(253,16%,7%,1) 0, transparent 50%),
        radial-gradient(at 100% 100%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-attachment: fixed; background-size: cover;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .glass-input {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white; transition: all 0.3s ease; font-size: 16px;
    }
    .glass-input:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
      outline: none;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes newUserSlide {
      0% { opacity: 0; transform: translateY(-30px) scale(0.9); }
      60% { transform: translateY(5px) scale(1.02); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .user-card { animation: slideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; opacity: 0; }
    .new-user-card {
      animation: newUserSlide 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      border: 2px solid #8b5cf6;
      box-shadow: 0 0 25px rgba(139, 92, 246, 0.5);
      z-index: 10;
    }

    .new-badge {
      position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white; padding: 4px 12px; border-radius: 20px;
      font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
      z-index: 20; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }

    .sync-indicator {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(139, 92, 246, 0.9); color: white;
      padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500;
      z-index: 50; transition: transform 0.3s ease;
      display: flex; align-items: center; gap: 6px;
    }
    .sync-indicator.visible { transform: translateX(-50%) translateY(0); }
    .sync-indicator.syncing::after {
      content: ''; width: 12px; height: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white; border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .offline-indicator {
      position: fixed; top: 0; left: 0; right: 0;
      background: #ef4444; color: white; text-align: center;
      padding: 0.5rem; font-size: 0.875rem; z-index: 100;
      transform: translateY(-100%); transition: transform 0.3s ease;
    }
    .offline-indicator.visible { transform: translateY(0); }

    .image-modal {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px); z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .image-modal.active { opacity: 1; pointer-events: all; }
    .image-modal img { max-width: 90%; max-height: 80vh; border-radius: 1rem; transform: scale(0.9); transition: transform 0.3s ease; }
    .image-modal.active img { transform: scale(1); }
    .modal-close {
      position: absolute; top: 1rem; right: 1rem; width: 40px; height: 40px;
      background: rgba(255, 255, 255, 0.1); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.3s;
    }
    .modal-close:hover { background: rgba(255, 255, 255, 0.2); }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    @media (max-width: 640px) {
      .glass-input { font-size: 16px !important; padding: 0.75rem 1rem; }
      .user-card { margin-bottom: 1rem; }
      .avatar-container { width: 80px !important; height: 80px !important; }
    }

    .instagram-link { position: relative; overflow: hidden; }
    .instagram-link::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .instagram-link:hover::before { left: 100%; }

    .avatar-container { position: relative; cursor: pointer; transition: transform 0.3s ease; width: 96px; height: 96px; }
    .avatar-container:hover { transform: scale(1.05); }
    .avatar-container::after {
      content: 'üîç'; position: absolute; bottom: 0; right: 0;
      width: 24px; height: 24px; background: rgba(0,0,0,0.6);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 12px; opacity: 0; transition: opacity 0.3s;
    }
    .avatar-container:hover::after { opacity: 1; }

    .empty-state-large {
      min-height: 60vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center; text-align: center; padding: 2rem;
    }
    .empty-icon {
      width: 120px; height: 120px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin-bottom: 1.5rem; animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .empty-icon svg { width: 60px; height: 60px; color: #8b5cf6; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .live-indicator {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 11px; color: #10b981; font-weight: 500;
    }
    .live-indicator::before {
      content: ''; width: 6px; height: 6px; background: #10b981;
      border-radius: 50%; animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
  </style>
</head>
<body class="antialiased min-h-screen">

  <div class="bg-gradient-mobile"></div>
  <div id="offlineIndicator" class="offline-indicator"><span>‚ö†Ô∏è ƒ∞nternet baƒülantƒ±sƒ± yoxdur</span></div>
  <div id="syncIndicator" class="sync-indicator"><span>Sinxronizasiya...</span></div>

  <div id="imageModal" class="image-modal" onclick="closeModal()">
    <div class="modal-close" onclick="event.stopPropagation(); closeModal()">
      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </div>
    <img id="modalImage" src="" alt="Profile">
  </div>

  <nav class="fixed top-0 w-full z-50 glass border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-14 sm:h-16">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
          </div>
          <span class="font-bold text-lg sm:text-xl bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">SocialConnect</span>
          <span class="live-indicator ml-2" id="liveIndicator" style="display:none;">LIVE</span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="forceSync()" class="group flex items-center gap-1.5 px-3 py-2 rounded-full glass hover:bg-white/10 transition-all active:scale-95">
            <svg id="refreshIcon" class="w-4 h-4 text-purple-400 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="text-xs font-medium">Yenil…ô</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="pt-20 sm:pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 mb-12">
      <div class="lg:col-span-5 flex flex-col justify-center space-y-4">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tight">
          ƒ∞cma il…ô <br>
          <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">∆èlaq…ô Qurun</span>
        </h1>
        <p class="text-base sm:text-lg text-gray-400">Yeni insanlarla tanƒ±≈ü olun v…ô ≈ü…ôb…ôk…ônizi geni≈ül…ôndirin.</p>
        <div class="flex gap-6 pt-2">
          <div>
            <div class="text-2xl sm:text-3xl font-bold text-white" id="total-users-count">0</div>
            <div class="text-xs text-gray-500 uppercase">ƒ∞stifad…ô√ßi</div>
          </div>
          <div>
            <div class="text-2xl sm:text-3xl font-bold text-white" id="online-count">0</div>
            <div class="text-xs text-gray-500 uppercase">Bu g√ºn</div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-7">
        <div class="glass rounded-2xl p-5 sm:p-8 relative overflow-hidden">
          <div class="absolute top-0 right-0 -mt-4 -mr-4 w-20 h-20 bg-purple-500 rounded-full blur-3xl opacity-20"></div>
          
          <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center gap-2">
            <span class="w-1 h-6 bg-purple-500 rounded-full"></span>
            Qeydiyyat Formu
          </h2>

          <form id="registerForm" class="space-y-4" onsubmit="handleRegister(event)">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-medium text-gray-400 uppercase">Ad</label>
                <input type="text" id="firstName" required class="w-full px-3 py-2.5 rounded-xl glass-input" placeholder="Adƒ±nƒ±z">
              </div>
              <div>
                <label class="text-xs font-medium text-gray-400 uppercase">Soyad</label>
                <input type="text" id="lastName" required class="w-full px-3 py-2.5 rounded-xl glass-input" placeholder="Soyadƒ±nƒ±z">
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-medium text-gray-400 uppercase">Ya≈ü</label>
                <input type="number" id="age" min="10" max="100" required class="w-full px-3 py-2.5 rounded-xl glass-input" placeholder="25">
              </div>
              <div>
                <label class="text-xs font-medium text-gray-400 uppercase">Cins</label>
                <select id="gender" required class="w-full px-3 py-2.5 rounded-xl glass-input appearance-none">
                  <option value="" disabled selected>Se√ßin</option>
                  <option value="Ki≈üi">Ki≈üi</option>
                  <option value="Qadƒ±n">Qadƒ±n</option>
                  <option value="Dig…ôr">Dig…ôr</option>
                </select>
              </div>
            </div>

            <div>
              <label class="text-xs font-medium text-gray-400 uppercase">Ail…ô V…ôziyy…ôti</label>
              <div class="flex gap-3 mt-1">
                <label class="flex-1 cursor-pointer">
                  <input type="radio" name="status" value="Subay" class="peer sr-only" checked>
                  <div class="text-center py-2.5 rounded-xl border border-white/10 bg-white/5 peer-checked:bg-purple-600 peer-checked:border-purple-500 transition-all text-sm">Subay</div>
                </label>
                <label class="flex-1 cursor-pointer">
                  <input type="radio" name="status" value="Evli" class="peer sr-only">
                  <div class="text-center py-2.5 rounded-xl border border-white/10 bg-white/5 peer-checked:bg-pink-600 peer-checked:border-pink-500 transition-all text-sm">Evli</div>
                </label>
              </div>
            </div>

            <div>
              <label class="text-xs font-medium text-gray-400 uppercase">Instagram</label>
              <div class="relative">
                <span class="absolute left-3 top-2.5 text-gray-500">@</span>
                <input type="text" id="instagram" required class="w-full pl-7 pr-3 py-2.5 rounded-xl glass-input" placeholder="istifadeci_adi">
              </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-xl shadow-lg shadow-purple-500/30 transform transition hover:-translate-y-0.5 active:scale-95 flex justify-center items-center gap-2">
              <span>Qeydiyyatdan Ke√ß</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>

    <div id="usersSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
        <div>
          <h3 class="text-xl sm:text-2xl font-bold text-white">Qeydiyyatdan Ke√ß…ônl…ôr</h3>
          <p class="text-xs text-gray-500 mt-1" id="lastSyncTime">Son yenil…ôm…ô: ƒ∞ndi</p>
        </div>
        <div class="flex gap-2 overflow-x-auto pb-2 w-full sm:w-auto no-scrollbar">
          <button onclick="filterUsers('all')" class="filter-btn px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 text-xs font-medium transition-colors ring-2 ring-purple-500 whitespace-nowrap">Hamƒ±sƒ±</button>
          <button onclick="filterUsers('Ki≈üi')" class="filter-btn px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/20 text-xs font-medium transition-colors whitespace-nowrap">Ki≈üi</button>
          <button onclick="filterUsers('Qadƒ±n')" class="filter-btn px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/20 text-xs font-medium transition-colors whitespace-nowrap">Qadƒ±n</button>
          <button onclick="filterUsers('Subay')" class="filter-btn px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/20 text-xs font-medium transition-colors whitespace-nowrap">Subay</button>
          <button onclick="filterUsers('Evli')" class="filter-btn px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/20 text-xs font-medium transition-colors whitespace-nowrap">Evli</button>
        </div>
      </div>

      <div id="usersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <!-- Users will be rendered here -->
      </div>

      <div id="emptyState" class="empty-state-large hidden">
        <div class="empty-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">H…ôl…ô he√ß kim yoxdur</h3>
        <p class="text-gray-400">ƒ∞lk qeydiyyatdan ke√ß…ôn siz olun!</p>
      </div>
    </div>

  </main>

  <div id="toast" class="fixed bottom-4 right-4 left-4 sm:left-auto transform translate-y-24 opacity-0 transition-all duration-300 z-50">
    <div class="glass bg-gray-900/90 border-l-4 border-green-500 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3">
      <div class="bg-green-500/20 p-2 rounded-full">
        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <div>
        <h4 class="font-bold text-sm" id="toastTitle">Uƒüurlu!</h4>
        <p class="text-xs text-gray-300" id="toastMsg">Qeydiyyat tamamlandƒ±.</p>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // KONFIQURASIYA
    // ==========================================
    const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLScHbTc16Jsmv5cdnUkxCAH5FxlOi9FiqG0aURzZQqhG4mgI9Q/formResponse";
    const API_GET_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgrPfCvZ_Q3YXuY9balsLJ5d7Wj8-P1uu8dfWhB-Af3VS9OrsPcBp4uswdCDBtud_ZGDB_oIVD5dMenu4ketgH_suCItsVOS0C0l0sfb4SQYLFmeoY649Cb6ztx-HJM2NVBtvYDe6T5LXQHrAouolaJCB6uzdCjwxchX9xS7CqoS-uiSLyBZ6KgeTh2jL3TNjARFjwCXqZJZ0paGTPnKnWVfFvaxLpidxam_NF64B_5czS3zkp8sqA0u5WLhHiiiCNWIzSyry_AW9E3m95ZQ0f8DkOWHA&lib=MZDG5OuFCsgObZ7QT_PNkFmCRMPvxsUvo";

    const ENTRY_FIRSTNAME = "entry.1178680962";
    const ENTRY_LASTNAME  = "entry.1475120277";
    const ENTRY_INSTAGRAM = "entry.1110943076";
    const ENTRY_AGE       = "entry.1294895519";
    const ENTRY_GENDER    = "entry.1632031862";
    const ENTRY_STATUS    = "entry.222463848";

    // ==========================================
    // STATE
    // ==========================================
    const LS_KEY = "sc_users_v2";
    const LS_MY_ID = "sc_my_id";
    const LS_PENDING = "sc_pending";
    
    let users = [];
    let currentFilter = "all";
    let isSyncing = false;
    let lastAddedId = null;
    let syncInterval = null;

    // ==========================================
    // UTILS
    // ==========================================
    function generateId() {
      return 'u_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 5);
    }

    function getAvatar(firstName, lastName, gender) {
      const name = `${firstName || ''} ${lastName || ''}`.trim();
      const seed = encodeURIComponent(name || 'User');
      let bg = gender === 'Ki≈üi' ? '3b82f6,2563eb' : gender === 'Qadƒ±n' ? 'ec4899,db2777' : '8b5cf6,7c3aed';
      return `https://api.dicebear.com/9.x/initials/svg?seed=${seed}&backgroundColor=${bg}&textColor=ffffff&size=128&radius=50&fontSize=50&chars=2`;
    }

    function timeAgo(ts) {
      if (!ts) return "Nam…ôlum";
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return "ƒ∞ndi";
      const m = Math.floor(s / 60);
      if (m < 60) return `${m} d…ôq …ôvv…ôl`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h} saat …ôvv…ôl`;
      const d = Math.floor(h / 24);
      return `${d} g√ºn …ôvv…ôl`;
    }

    // ==========================================
    // STORAGE
    // ==========================================
    function saveUsers() {
      localStorage.setItem(LS_KEY, JSON.stringify(users));
    }

    function loadUsers() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }

    function savePending(user) {
      const pending = JSON.parse(localStorage.getItem(LS_PENDING) || '[]');
      pending.push({...user, pending: true, retryCount: 0});
      localStorage.setItem(LS_PENDING, JSON.stringify(pending));
    }

    function getPending() {
      try {
        return JSON.parse(localStorage.getItem(LS_PENDING) || '[]');
      } catch { return []; }
    }

    function removePending(id) {
      const pending = getPending().filter(p => p.id !== id);
      localStorage.setItem(LS_PENDING, JSON.stringify(pending));
    }

    // ==========================================
    // API
    // ==========================================
    async function fetchAPI() {
      if (!API_GET_URL.includes('http')) return [];
      try {
        const res = await fetch(API_GET_URL + '&t=' + Date.now());
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.users)) return [];
        
        return data.users.map(u => ({
          id: u.id || generateId(),
          firstName: u.FirstName || u.firstName || "",
          lastName: u.LastName || u.lastName || "",
          age: u.Age || u.age || "",
          gender: u.Gender || u.gender || "Dig…ôr",
          status: u.Status || u.status || "Subay",
          instagram: u.Instagram || u.instagram || "",
          timestamp: new Date(u.Timestamp || u.timestamp || Date.now()).getTime(),
          source: 'api'
        }));
      } catch (e) {
        console.error('API x…ôtasƒ±:', e);
        return [];
      }
    }

    async function sendToForms(user) {
      const fd = new FormData();
      fd.append(ENTRY_FIRSTNAME, user.firstName);
      fd.append(ENTRY_LASTNAME, user.lastName);
      fd.append(ENTRY_AGE, user.age);
      fd.append(ENTRY_GENDER, user.gender);
      fd.append(ENTRY_STATUS, user.status);
      fd.append(ENTRY_INSTAGRAM, user.instagram);
      fd.append('userId', user.id);

      await fetch(FORM_ACTION_URL, { method: "POST", mode: "no-cors", body: fd });
    }

    // ==========================================
    // SINXRONIZASIYA (∆èSAS)
    // ==========================================
    async function sync(showLoading = false) {
      if (isSyncing) return;
      isSyncing = true;
      
      if (showLoading) showSync(true);
      
      try {
        // 1. API-d…ôn √ß…ôk
        const apiUsers = await fetchAPI();
        
        // 2. Local-ƒ± al
        let localUsers = loadUsers();
        
        // 3. Pending-l…ôri …ôlav…ô et (g√∂nd…ôrilm…ômi≈ül…ôr)
        const pending = getPending();
        
        // 4. Birl…ô≈üdir (Map il…ô duplicate olmadan)
        const merged = new Map();
        
        // ∆èvv…ôlc…ô API-d…ôn g…ôl…ônl…ôr
        apiUsers.forEach(u => merged.set(u.id, u));
        
        // Sonra local (…ôg…ôr API-d…ô yoxdursa v…ô ya daha yenidirs…ô)
        localUsers.forEach(u => {
          const existing = merged.get(u.id);
          if (!existing || u.timestamp > existing.timestamp) {
            merged.set(u.id, u);
          }
        });
        
        // Pending-l…ôri d…ô …ôlav…ô et (…ôn prioritetli)
        pending.forEach(u => {
          merged.set(u.id, {...u, pending: true});
        });
        
        // 5. Array-…ô √ßevir v…ô sort et
        users = Array.from(merged.values()).sort((a, b) => b.timestamp - a.timestamp);
        
        // 6. Yadda saxla
        saveUsers();
        
        // 7. G√∂st…ôr
        render();
        updateStats();
        
        // 8. Pending-l…ôri g√∂nd…ôrm…ôy…ô √ßalƒ±≈ü (retry)
        await retryPending();
        
        updateLastSyncTime();
        
      } catch (e) {
        console.error('Sync x…ôtasƒ±:', e);
      } finally {
        isSyncing = false;
        showSync(false);
      }
    }

    async function retryPending() {
      const pending = getPending();
      for (const user of pending) {
        try {
          await sendToForms(user);
          removePending(user.id);
          // ƒ∞stifad…ô√ßini pending-d…ôn √ßƒ±xart
          const idx = users.findIndex(u => u.id === user.id);
          if (idx !== -1) {
            users[idx].pending = false;
          }
        } catch (e) {
          console.log('Retry failed:', user.id);
        }
      }
      saveUsers();
    }

    // ==========================================
    // UI
    // ==========================================
    function render() {
      const grid = document.getElementById('usersGrid');
      const empty = document.getElementById('emptyState');
      
      grid.innerHTML = '';
      
      const filtered = users.filter(u => {
        if (currentFilter === 'all') return true;
        return u.gender === currentFilter || u.status === currentFilter;
      });

      if (filtered.length === 0) {
        empty.classList.remove('hidden');
        return;
      } else {
        empty.classList.add('hidden');
      }

      filtered.forEach((user, idx) => {
        const isNew = user.id === lastAddedId;
        const isPending = user.pending;
        const delay = isNew ? 0 : idx * 50;
        
        const card = document.createElement('div');
        card.className = `user-card glass rounded-2xl p-4 sm:p-6 relative ${isNew ? 'new-user-card' : ''}`;
        card.style.animationDelay = `${delay}ms`;
        
        const name = `${user.firstName} ${user.lastName}`.trim();
        const ig = user.instagram.replace('@', '');
        const igLink = `https://instagram.com/${ig}`;
        
        card.innerHTML = `
          ${isNew ? '<div class="new-badge">Yeni</div>' : ''}
          ${isPending ? '<div class="absolute top-2 right-2 w-2 h-2 bg-yellow-500 rounded-full animate-pulse" title="G√∂nd…ôrilir..."></div>' : ''}
          
          <div class="absolute top-3 right-3">
            <span class="px-2 py-0.5 text-xs rounded-md ${user.status === 'Evli' ? 'bg-pink-500/20 text-pink-300' : 'bg-blue-500/20 text-blue-300'} border border-white/5">
              ${user.status}
            </span>
          </div>

          <div class="flex flex-col items-center text-center">
            <div class="avatar-container relative mb-3" onclick="openModal('${getAvatar(user.firstName, user.lastName, user.gender)}')">
              <div class="w-20 h-20 sm:w-24 sm:h-24 rounded-full p-1 bg-gradient-to-tr from-purple-500 to-pink-500">
                <img src="${getAvatar(user.firstName, user.lastName, user.gender)}" class="w-full h-full rounded-full object-cover border-2 border-[#0f172a]" loading="lazy">
              </div>
            </div>

            <h3 class="text-lg font-bold text-white mb-0.5 truncate w-full">${name}</h3>
            <p class="text-xs text-gray-400 mb-3">${user.age ? user.age + ' ya≈ü' : ''} ${user.age && user.gender ? '‚Ä¢' : ''} ${user.gender}</p>

            <a href="${igLink}" target="_blank" class="instagram-link w-full py-2 rounded-xl bg-gradient-to-r from-purple-600/20 to-pink-600/20 border border-purple-500/30 text-purple-300 hover:text-white hover:from-purple-600 hover:to-pink-600 transition-all flex items-center justify-center gap-1 text-sm">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
              <span class="font-medium truncate">@${ig}</span>
            </a>

            <div class="mt-3 text-xs text-gray-500 flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <span>${timeAgo(user.timestamp)}</span>
              ${isPending ? '<span class="text-yellow-500">‚Ä¢ G√∂nd…ôrilir</span>' : ''}
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      // Scroll to new
      if (lastAddedId) {
        setTimeout(() => {
          const newCard = document.querySelector('.new-user-card');
          if (newCard) newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => { lastAddedId = null; }, 5000);
        }, 100);
      }
    }

    function updateStats() {
      document.getElementById('total-users-count').textContent = users.length;
      const today = users.filter(u => Date.now() - u.timestamp < 86400000).length;
      document.getElementById('online-count').textContent = today;
    }

    function updateLastSyncTime() {
      const el = document.getElementById('lastSyncTime');
      const now = new Date();
      el.textContent = `Son yenil…ôm…ô: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
    }

    function showSync(show) {
      const el = document.getElementById('syncIndicator');
      if (show) el.classList.add('visible', 'syncing');
      else el.classList.remove('visible', 'syncing');
    }

    function showToast(ok, msg) {
      const toast = document.getElementById('toast');
      document.getElementById('toastTitle').textContent = ok ? 'Uƒüurlu!' : 'X…ôta!';
      document.getElementById('toastMsg').textContent = msg;
      toast.classList.remove('translate-y-24', 'opacity-0');
      setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
    }

    // ==========================================
    // EVENTS
    // ==========================================
    async function handleRegister(e) {
      e.preventDefault();
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">‚Üª</span> G√∂nd…ôrilir...';

      const user = {
        id: generateId(),
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        status: document.querySelector('input[name="status"]:checked').value,
        instagram: document.getElementById('instagram').value.trim().replace('@',''),
        timestamp: Date.now(),
        pending: true
      };

      // 1. D…ôrhal local-a …ôlav…ô et v…ô g√∂st…ôr
      lastAddedId = user.id;
      users.unshift(user);
      saveUsers();
      render();
      updateStats();
      showToast(true, "Qeydiyyatƒ±nƒ±z q…ôbul edildi!");
      
      // 2. Formu t…ômizl…ô v…ô reset
      form.reset();
      btn.disabled = false;
      btn.innerHTML = '<span>Qeydiyyatdan Ke√ß</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>';

      // 3. Pending-…ô …ôlav…ô et
      savePending(user);

      // 4. Arxa planda g√∂nd…ôr (await etm…ô!)
      sendToForms(user).then(() => {
        // Uƒüurlu olduqda pending-d…ôn √ßƒ±xart
        removePending(user.id);
        const idx = users.findIndex(u => u.id === user.id);
        if (idx !== -1) {
          users[idx].pending = false;
          saveUsers();
          render();
        }
      }).catch(err => {
        console.error('Forms g√∂nd…ôrm…ô x…ôtasƒ±:', err);
      });

      // 5. 3 saniy…ô sonra sync et (yeni data API-d…ô ola bil…ôr)
      setTimeout(() => sync(false), 3000);
    }

    function filterUsers(type) {
      currentFilter = type;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        const isActive = btn.getAttribute('onclick').includes(`'${type}'`);
        btn.classList.toggle('ring-2', isActive);
        btn.classList.toggle('ring-purple-500', isActive);
        btn.classList.toggle('bg-white/20', isActive);
        btn.classList.toggle('bg-white/5', !isActive);
      });
      render();
    }

    async function forceSync() {
      const icon = document.getElementById('refreshIcon');
      icon.classList.add('animate-spin');
      await sync(true);
      icon.classList.remove('animate-spin');
      showToast(true, "Siyahƒ± yenil…ôndi");
    }

    function openModal(src) {
      document.getElementById('modalImage').src = src;
      document.getElementById('imageModal').classList.add('active');
    }
    function closeModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    // ==========================================
    // INIT
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      // ƒ∞lk y√ºkl…ôm…ô
      users = loadUsers();
      render();
      updateStats();
      
      // Filter UI
      filterUsers('all');
      
      // ƒ∞lk sync
      await sync(true);
      
      // Avtomatik sync (h…ôr 10 saniy…ôd…ô bir)
      syncInterval = setInterval(() => {
        if (document.visibilityState === 'visible') {
          sync(false);
        }
      }, 10000);
      
      // S…ôhif…ô g√∂r√ºn…ônd…ô d…ôrhal sync
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          sync(false);
          document.getElementById('liveIndicator').style.display = 'inline-flex';
          setTimeout(() => {
            document.getElementById('liveIndicator').style.display = 'none';
          }, 3000);
        }
      });
      
      // Online/Offline
      window.addEventListener('online', () => {
        document.getElementById('offlineIndicator').classList.remove('visible');
        sync(false);
      });
      window.addEventListener('offline', () => {
        document.getElementById('offlineIndicator').classList.add('visible');
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  </script>
</body>
</html>
